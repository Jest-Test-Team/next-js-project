# 工作流程的名稱
name: Deploy to Cloudflare Pages

# 觸發此工作流程的事件
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      # 步驟 1: 取得您的程式碼
      - name: Checkout
        uses: actions/checkout@v4

      # 步驟 2: 設定 Node.js 環境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
          # ✅ 修正: 明確指定 package-lock.json 檔案的正確路徑
          cache-dependency-path: aqi-dashboard/package-lock.json

      # 步驟 3: 安裝專案依賴套件
      - name: Install dependencies
        # ✅ 修正: 進入專案子目錄後再執行安裝指令
        working-directory: ./aqi-dashboard
        run: npm ci

      # 步驟 4: 建置 Next.js 專案
      - name: Build
        # ✅ 修正: 進入專案子目錄後再執行建置指令
        working-directory: ./aqi-dashboard
        env:
          NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY }}
        run: npm run build

      # 步驟 5: 發布到 Cloudflare Pages
      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
          # ⚠️ 請務必將 'your-project-name' 替換成您在 Cloudflare 上的真實專案名稱
          projectName: 'next-js-project' 
          
          # ✅ 修正: 指向位於子目錄中的建置輸出資料夾
          directory: aqi-dashboard/out
          
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

